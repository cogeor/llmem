# LLMem Frontend Design & Requirements

## Goals

Single command (`llmem.openPanel`) opens a singleton **WebviewPanel** containing:
1.  **Interactive Plot View**: Visualizes Import/Call graphs using Vis.js.
2.  **Chat Interface**: Conversational interface to the "Antigravity" agent (LLM).
3.  **Control Panel**: Buttons to trigger Code Context Generation (Artifacts + Graph).

## Components & Data Flow

### 1. Extension Host (`src/extension/`)

*   **Command**: `llmem.openPanel`
    *   Creates or reveals `llmem.panel` (WebviewPanel).
    *   Restores state if needed.
*   **Data Source**:
    *   **Artifacts**: Triggers `ArtifactService.analyzeCodebase` (exposed via MCP or direct import).
    *   **Graphs**: specific call to `buildGraphs(config.artifactRoot)` from `src/graph/index.ts`.
*   **Message Handling**:
    *   `webview:ready` -> Extension sends initial state.
    *   `action:generate_context` -> Extension runs extraction pipeline -> sends `plot:update` + `status:update`.
    *   `chat:send` -> Extension forwards to Agent/LLM -> sends `chat:response`.

### 2. Webview (`src/webview/`)

*   **Technology**: HTML/CSS/JS (bundled). No React/Vue unless necessary (keep it minimal/vanilla as per goals).
*   **Layout**:
    *   **Sidebar/Top**: Controls ("Update Context", "Switch Graph Type").
    *   **Main**: Split view. Left = Graph (Vis.js container). Right = Chat.
*   **State Management**:
    *   `vsCodeApi.setState()` for persistence.
    *   Local store for graph data and chat history.

### 3. Code Context Generation (Pipeline)

This is the "Generate" action in the UI:

1.  **User clicks "Update Context"**.
2.  **Webview** sends `action:generate_context`.
3.  **Extension**:
    a.  **Step 1: Artifacts**: Calls `mcp.analyzeCodebase(workspaceRoot)`.
        *   Parses files -> updates `.artifacts/` directory.
    b.  **Step 2: Graphs**: Calls `buildGraphs(config.artifactRoot)` (from `src/graph`).
        *   Reads artifacts -> builds `ImportGraph` & `CallGraph`.
    c.  **Step 3: Push**: Sends `plot:data` with `{ nodes, edges }` to Webview.

## Messaging Contract

| Direction | Type | Payload | Purpose |
| :--- | :--- | :--- | :--- |
| **Ext -> Web** | `plot:data` | `{ type: 'import'\|'call', data: { nodes, edges } }` | Updates the visualization. |
| **Ext -> Web** | `status:update` | `{ status: 'idle'\|'working', message: string }` | Shows progress (e.g. "Parsing..."). |
| **Ext -> Web** | `chat:append` | `{ role: 'user'\|'assistant', content: string }` | Appends chat message. |
| **Web -> Ext** | `action:generate_context` | `{}` | Triggers artifact/graph regeneration. |
| **Web -> Ext** | `chat:send` | `{ text: string }` | Sends user query to agent. |

## UX details

*   **Singleton**: Only one panel active at a time.
*   **Persistence**: Chat history should survive panel reload (store in `context.globalState` or Webview `setState`).
*   **Graph Interaction**:
    *   Click node -> Focus in chat? Open file? (Future scope).
    *   Zoom/Pan enabled.
