# Part 4: Text Processing Implementation Plan (MVP)
# Component: src/parser/

================================================================================
## PURPOSE
================================================================================
Code structure extraction using tree-sitter. Parses source files into AST,
extracts functions/classes/methods, and stores as .artifact files.

MVP GOAL: For each source file, generate a corresponding .artifact file
containing the list of functions, classes, and methods.

Example:
  src/extension/config.ts → .artifacts/src/extension/config.ts.artifact
  
  Contents:
  - Functions: loadConfig, getConfig, isConfigLoaded, resetConfig
  - Interfaces: Config
  - Constants: DEFAULT_CONFIG

================================================================================
## FILES & RESPONSIBILITIES
================================================================================

### parser.ts
- Tree-sitter initialization
- Language detection from file extension
- Load appropriate language grammar
- Parse file content into AST

### extractor.ts
- Walk AST to find code constructs
- Extract function definitions (name, params, return type)
- Extract class definitions (name, methods, properties)
- Extract method signatures within classes
- Handle nested structures

### outline.ts
- Build high-level code structure summary
- Format outline for LLM consumption
- Aggregate file-level outlines into project overview

### types.ts
- FunctionInfo, ClassInfo, MethodInfo interfaces
- CodeOutline structure
- FileOutline for per-file summaries

================================================================================
## MODULE INTERACTIONS
================================================================================

INTERNAL (within parser/):
┌─────────────────┐
│    parser.ts    │
│                 │
│ - parse(file)   │
│ - detectLang()  │
└────────┬────────┘
         │ returns AST
         ▼
┌─────────────────┐
│  extractor.ts   │
│                 │
│ - extractFns()  │
│ - extractCls()  │
└────────┬────────┘
         │ returns structured data
         ▼
┌─────────────────┐
│   outline.ts    │
│                 │
│ - buildOutline()│
│ - formatForLLM()│
└─────────────────┘

All modules import from types.ts

EXTERNAL DEPENDENCIES:
- outline.ts → Called by llm/prompt-builder.ts
- extractor.ts → May be called by mcp/tools.ts for direct queries

================================================================================
## INTERFACES
================================================================================

```typescript
// types.ts
interface FunctionInfo {
  name: string;
  params: Array<{ name: string; type?: string }>;
  returnType?: string;
  startLine: number;
  endLine: number;
  docstring?: string;
}

interface ClassInfo {
  name: string;
  methods: FunctionInfo[];
  properties: Array<{ name: string; type?: string }>;
  startLine: number;
  endLine: number;
  docstring?: string;
}

interface FileOutline {
  path: string;
  language: string;
  functions: FunctionInfo[];
  classes: ClassInfo[];
  imports?: string[];
}

interface CodeOutline {
  files: FileOutline[];
  summary: string;  // High-level description for LLM
}

// parser.ts exports
function parseFile(filePath: string, content: string): SyntaxTree;
function detectLanguage(filePath: string): string;

// extractor.ts exports
function extractFunctions(tree: SyntaxTree, lang: string): FunctionInfo[];
function extractClasses(tree: SyntaxTree, lang: string): ClassInfo[];

// outline.ts exports
function buildFileOutline(filePath: string, content: string): FileOutline;
function buildCodeOutline(files: Array<{path: string, content: string}>): CodeOutline;
function formatOutlineForLLM(outline: CodeOutline): string;
```

================================================================================
## LANGUAGE SUPPORT
================================================================================

Priority languages (Phase 1):
- TypeScript (.ts, .tsx)
- JavaScript (.js, .jsx)
- Python (.py)

Future languages:
- Go (.go)
- Rust (.rs)
- Java (.java)
- C/C++ (.c, .cpp, .h)

Language detection: Based on file extension mapping

================================================================================
## TREE-SITTER QUERIES
================================================================================

Example TypeScript queries:
```
; Functions
(function_declaration
  name: (identifier) @function.name)

; Arrow functions assigned to const
(lexical_declaration
  (variable_declarator
    name: (identifier) @function.name
    value: (arrow_function)))

; Classes
(class_declaration
  name: (type_identifier) @class.name)

; Methods
(method_definition
  name: (property_identifier) @method.name)
```

================================================================================
## IMPLEMENTATION ORDER
================================================================================

1. types.ts
   - Define all interfaces

2. parser.ts
   - Tree-sitter setup
   - Language detection
   - Basic parsing

3. extractor.ts
   - TypeScript/JavaScript extraction first
   - Add Python support
   - Query-based extraction

4. outline.ts
   - Combine extractors
   - Format for LLM prompts

================================================================================
## DEPENDENCIES
================================================================================

External packages:
- tree-sitter (core library)
- tree-sitter-typescript
- tree-sitter-javascript
- tree-sitter-python
- (additional language packages as needed)

Internal dependencies:
- Depends on: (none - utility module)
- Depended on by: llm/prompt-builder.ts, mcp/tools.ts

================================================================================
## TESTING
================================================================================

### Unit Tests (parser/)

parser.ts:
- detectLanguage() identifies TypeScript files
- detectLanguage() identifies Python files
- detectLanguage() returns "unknown" for unsupported
- parseFile() returns valid AST for TypeScript
- parseFile() returns valid AST for Python

extractor.ts:
- extractFunctions() finds top-level functions
- extractFunctions() finds arrow functions
- extractFunctions() extracts parameters and return types
- extractClasses() finds class declarations
- extractClasses() extracts methods
- extractClasses() extracts properties
- Handles nested classes/functions

outline.ts:
- buildFileOutline() combines parser + extractor
- buildCodeOutline() aggregates multiple files
- formatOutlineForLLM() produces readable output
- Summary generation is concise

### Integration Tests (parser/ ↔ llm/)

Parser ↔ Prompt Builder:
- Test: CodeOutline integrates into prompt
- Test: Large projects truncate appropriately
- Test: Empty outline handled gracefully

Parser ↔ MCP:
- Test: MCP can request outline directly
- Test: Outline included in generate_artifact flow

### Language-Specific Tests

TypeScript:
- Test: Functions, classes, interfaces, types
- Test: Arrow functions and exports
- Test: Decorators and generics

JavaScript:
- Test: ES6 classes and functions
- Test: CommonJS exports
- Test: Prototype methods

Python:
- Test: Functions and classes
- Test: Decorators
- Test: Method types (instance, class, static)

### Module Compatibility Tests

Cross-Language:
- Test: Mixed-language project outline
- Test: Unsupported file types skipped gracefully

Performance:
- Test: Large file parsing (>1000 lines)
- Test: Many files (>100) in outline
- Test: Deeply nested structures
