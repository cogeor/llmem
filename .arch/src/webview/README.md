# FOLDER: src/webview

## Overview
The `src/webview` folder contains the **dual-mode frontend** for the LLMem application. This UI can run either as a VS Code webview panel (plugin mode) or as a standalone web application served by an HTTP server (webserver mode). The folder provides a rich SPA-style interface with three main views: a file explorer (Worktree), design documentation viewer, and an interactive graph visualization.

The architecture is designed around a **DataProvider abstraction** that hides the environment differences from UI components. In plugin mode, data is exchanged via VS Code's postMessage IPC; in webserver mode, data is baked into JavaScript globals at generation time and live updates come via WebSocket. This separation allows the same React-like component architecture to work seamlessly in both environments.

Key responsibilities include: worktree generation from the project filesystem, design document loading and markdown rendering, graph data preparation for visualization, and coordinating file watching state between the UI and backend services.

## Inputs

**External Dependencies:**
- `fs`, `fs-extra`, `path` - Node.js filesystem operations for worktree scanning and file I/O
- `esbuild` - TypeScript bundling for static webview generation
- `marked` - Markdown to HTML conversion (ESM dynamic import)
- `vis-network` - Graph visualization library (browser-side)

**Internal Dependencies:**
- `src/graph/edgelist.ts` - Import/Call edge list stores for graph data
- `src/graph/webview-data.ts` - Graph data transformation for visualization
- `src/graph/worktree-state.ts` - WatchService for file watching state persistence
- `src/parser/config.ts` - Supported file extension detection
- `src/parser/ts-service.ts` - TypeScript language service for code analysis
- `src/scripts/generate-call-edges.ts` - Edge generation for code analysis

## Outputs

**Main Exports:**
- `WebviewDataService` - Central service to aggregate graph, worktree, and design doc data
- `generateStaticWebview()` - Generates a complete static HTML bundle for webserver mode
- `generateWorkTree()` - Creates the file system tree structure from project root
- `DesignDocManager` / `loadDesignDocs()` - Loads `.arch/` markdown docs with HTML rendering
- `LiveReloadClient` - WebSocket client for browser live-reload
- `DataProvider` interface + implementations (`VSCodeDataProvider`, `StaticDataProvider`)

**UI Components (browser-side):**
- `Worktree`, `GraphView`, `DesignTextView` - Main view components
- `State`, `Router` - SPA state management and view switching

## Architecture

**Dual-Mode Architecture:**
The webview operates in two distinct modes:
1. **Plugin Mode (VS Code)**: `panel.ts` creates a webview panel, the UI bundle is served from `dist/webview/`, and all data flows via postMessage IPC. `VSCodeDataProvider` wraps the VS Code API.
2. **Webserver Mode (Browser)**: `GraphServer` serves static files from `.artifacts/webview/` generated by `generator.ts`. Data is baked into JS files, live updates via WebSocket.

**Data Flow:**
```
Backend Services                    UI Components
─────────────────                   ──────────────
data-service.ts ──┬──> panel.ts (postMessage) ──> VSCodeDataProvider ──┐
                  │                                                      │
                  └──> generator.ts (window.*) ──> StaticDataProvider ──┼──> Worktree
                                                                         │   DesignTextView
                                                                         └── GraphView
```

**Component Architecture:**
- State management via `State` class (pub/sub pattern)
- `Router` controls view visibility (design vs graph)
- Each component has `mount()` and subscribes to state changes
- Shadow DOM used for design doc styling isolation

**File Watching:**
- `WatchService` persists watched file paths to `.artifacts/worktree-state.json`
- Plugin: `HotReloadService` watches VS Code file events, regenerates edges for watched files
- Webserver: `FileWatcherService` in server watches source files, triggers WebSocket reload

**Key Design Decisions:**
- IIFE bundle format (not ESM) for file:// compatibility in static mode
- Dynamic import for `marked` (ESM-only package in CommonJS context)
- Path normalization to forward slashes throughout for cross-platform consistency

## Key Files
- **data-service.ts**: Central WebviewDataService class that aggregates all data needed for the webview: loads/generates edge lists, scans worktree, and collects design docs. Used by both panel.ts (plugin) and generator.ts (webserver).
- **generator.ts**: generateStaticWebview() function that creates a complete standalone HTML bundle. Bundles TypeScript via esbuild, copies assets, injects graph/worktree/design data as window globals.
- **worktree.ts**: generateWorkTree() function that recursively scans a directory tree and produces the ITreeNode structure used by the explorer. Includes file metadata like line counts.
- **design-docs.ts**: DesignDocManager class that walks the .arch/ directory, reads .md files, converts them to HTML via marked, and returns a keyed dictionary for the UI.
- **live-reload.ts**: LiveReloadClient class for browser-side WebSocket connection. Listens for 'reload' messages from the HTTP server and triggers page refresh.
- **ui/main.ts**: Main entry point for the browser-side UI. Initializes components (Worktree, GraphView, DesignView), creates the appropriate DataProvider based on environment, and bootstraps the SPA.
- **ui/services/dataProvider.ts**: DataProvider interface defining the contract for data loading. Abstracts VS Code postMessage vs static globals, enabling mode-agnostic UI components.
- **ui/services/vscodeDataProvider.ts**: VSCodeDataProvider implementation that receives data via VS Code postMessage IPC. Handles data:init, data:refresh, state:watchedPaths messages from the extension.
- **ui/services/staticDataProvider.ts**: StaticDataProvider implementation that reads from window.GRAPH_DATA, window.WORK_TREE, window.DESIGN_DOCS globals injected by the generator.
- **ui/components/Worktree.ts**: Explorer tree component that displays the file/folder hierarchy with expandable nodes. Handles selection, watch toggle buttons, and state synchronization.
