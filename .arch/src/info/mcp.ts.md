# DESIGN DOCUMENT: src/info/mcp.ts

> **Instructions:** This document serves as a blueprint for implementing the source code. Review the specifications below before writing code.

---

## FILE OVERVIEW

`src/info/mcp.ts` implements the core logic for the "file_info" MCP tool. It acts as a bridge between the MCP server and the internal analysis services (`TypeScriptService`, `TypeScriptExtractor`, `ArtifactService`). Its primary responsibility is to extract structural information (imports, entities, call graph) from a source file and prepare a context-rich prompt for an LLM to generate detailed semantic documentation.

**Inputs:** Workspace root directory path, relative file path, access to file system.

**Outputs:** FileInfoMcpData object (containing source code, structural markdown, and artifact paths), and enriched design documentation via report tool.

---

## FUNCTION SPECIFICATIONS

### `getFileInfoForMcp`

**Purpose:** Orchestrates the extraction of file metadata and structural info for MCP consumption.

**Implementation:**

- Constructs absolute path from `rootDir` and `filePath`. Checks existence.
- Reads raw source code from disk.
- Dynamically imports `TypeScriptService`, `TypeScriptExtractor`, and other dependencies (lazy loading).
- Instantiates `TypeScriptService` and `TypeScriptExtractor` using `rootDir`.
- Calls `extractor.extract(absolutePath)` to get the `FileArtifact`. Throws if failed.
- Calls `artifactToEdgeList` to convert the AST artifact into a graph format.
- Filters import edges using `filterImportEdges` and `getImportEdges`.
- Filters call edges:
    - Removes calls to standard library functions (using a hardcoded `stdlibFunctions` set containing explicit method names like `map`, `filter`, `log`, etc.).
    - Formats edge strings showing "Source -> Target" or "Source -> File:Target".
- Builds a markdown string combining Imports, Entities, and Call Edges.
- Extracts legacy `FileInfo` for compatibility.
- Constructs and returns the `FileInfoMcpData` object.

### `buildEnrichmentPrompt`

**Purpose:** Generates the specific prompt used to instruct the LLM to write the design document.

**Implementation:**

- Calculates line count of source code.
- Determines language ID from file path.
- Constructs a markdown string with sections:
    - "DESIGN DOCUMENT GENERATION TASK" header.
    - "LLM CONFIGURATION" with strict parameters (max_tokens, reasoning, temperature).
    - "FILE BEING DOCUMENTED" metadata.
    - "STRUCTURAL ANALYSIS" containing the markdown generated by `getFileInfoForMcp`.
    - "SOURCE CODE" block wrapped in language-specific triple backticks.
    - "YOUR TASK" section detailing the required output sections (Overview, Data Structures, Function Specifications, Control Flow, Reimplementation Notes).
    - "OUTPUT FORMAT" specifying the exact JSON structure for `report_file_info`.
    - "POST-SAVE STEP" instruction to copy artifacts to `.arch`.
- Returns the complete prompt string.

### `renderEnrichedMarkdown`

**Purpose:** Formats the structured enriched data into a readable Markdown document.

**Implementation:**

- Iterates through sections (Overview, Functions, Classes).
- Merges original structural info (signatures) with enriched semantic info (purpose, implementation) from the LLM.
- Format:
    - Title: File path.
    - Overview section.
    - For each function: Signature (header), Purpose, Implementation (bullet points), Callers list.
    - For classes: Similar structure, iterating over methods.
- Returns the joined markdown string.

### `saveEnrichedFileInfo`

**Purpose:** (Disabled) Formerly used to save the generated documentation to disk.

**Implementation:**

- Logs an error message: `[info/mcp] saveEnrichedFileInfo disabled - using edge list`.
- Returns an empty string.
- (Legacy code commented out: typically would render markdown and write to `.artifacts` directory).
